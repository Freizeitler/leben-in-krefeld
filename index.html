<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title itemprop="name">A-K Catalog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style type="text/css">

  </style>
  <link rel="stylesheet" href="./assets/css/app.css">
</head>

<body>




  <header class="header" role="banner">
    <h1 class="header__headline">Leben in Krefeld</h1>
  </header>


  <div class="app" role="tablist">

    <input type="radio" name="category" id="category01" class="menu-category" checked autofocus role="tab" />
    <label for="category01" class="menu-category">&hellip;</label>
    <input type="radio" name="category" id="category02" class="menu-category" role="tab" />
    <label for="category02" class="menu-category">&hellip;</label>


    <section class="message" id="jsMessage">
      <p class="message__text">Aktualisieren<span class="message__waiting">...</span> <span id="jsStatus" class="message__status">Sorry, I need JavaScript!</span></p>
    </section>


    <main class="main" role="main">

      <section class="category-section category-section__01" id="jsSection1">
        <h2 class="category-section__headline">Familienveranstaltungen aktuell</h2>

        <div class="search-bar">
          <label for="serach"><strong>Ich suche etwas Bestimmtes&hellip;</strong></label><br>
          <input type="text" class="search-bar__input" id="search" placeholder="z. B.: Theater" value="" />
        </div>



        <svg class="symbol-container" width="0" height="0" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <defs>
            <symbol id="icon-smiley" viewBox="0 0 32 32">
              <title>Smiley</title>
              <path class="path1" d="M16 32c8.837 0 16-7.163 16-16s-7.163-16-16-16-16 7.163-16 16 7.163 16 16 16zM16 3c7.18 0 13 5.82 13 13s-5.82 13-13 13-13-5.82-13-13 5.82-13 13-13zM16.961 22.22c4.383-0.866 7.785-2.861 9.014-5.519-0.677 5.249-5.047 9.299-10.339 9.299-3.726 0-6.996-2.009-8.84-5.030 2.2 1.721 6.079 2.056 10.165 1.249zM20 11c0-1.657 0.895-3 2-3s2 1.343 2 3c0 1.657-0.895 3-2 3s-2-1.343-2-3zM11 11.609c-1.306 0-2.417 0.489-2.829 1.172-0.111-0.183-0.171-1.005-0.171-1.211 0-0.971 1.343-1.758 3-1.758s3 0.787 3 1.758c0 0.206-0.061 1.028-0.171 1.211-0.412-0.683-1.522-1.172-2.829-1.172z"></path>
            </symbol>
          </defs>
        </svg>

        <div class="teaser-section" id="jsTeaserSpirituous">


        </div>
      </section>


      <section class="category-section category-section__02" id="jsSection2">
        <h2 class="category-section__headline">Soft drinks</h2>

        <input type="checkbox" name="category02-filter" id="category02-filter01" class="menu-category-filter" data-filter="one" />
        <label for="category02-filter01">Beginner</label>
        <input type="checkbox" name="category02-filter" id="category02-filter02" class="menu-category-filter" data-filter="two" />
        <label for="category02-filter02">Advanced</label>

        <div class="teaser-section" id="jsTeaserNonAlc">



        </div>
      </section>


    </main>
  </div>

  <script type="text/javascript">
    // template engine
    'use strict';

    var httpRequest;
    var targetMessage = document.getElementById('jsMessage');

    targetMessage.classList.add('hide');

    // make request
    function makeRequest(url, callback) {
      httpRequest = new XMLHttpRequest();
      console.log(callback, url, httpRequest.readyState, httpRequest.status);

      httpRequest.open('GET', url);
      httpRequest.send();
      httpRequest.onreadystatechange = callback;

      // fallback for httpRequest
      if (!httpRequest) {
        targetMessage.classList.remove('hide');
        document.getElementById('jsStatus').textContent = 'Sorry, I need a connection!';
        return false;
      }
    }

    // insert teaser template
    function insertTemplate(articleTarget, dataset, i) {
      articleTarget.insertAdjacentHTML('afterbegin',
        '<article class="teaser-section__teaser" data-tag="' + dataset.id + '" data-id="' + dataset.id + '">' +
        setImage(dataset) +
        '<div  class="teaser-section__text search-content">' +
        '<h3 class="teaser-section__headline">' + dataset.title + '</h3>' +
        '<p class="teaser-section__tags"><strong>Art der Veranstaltung:</strong> <em>' + getTags(dataset) + '</em></p>' +
        formatDate(dataset) +
        '<p class="teaser-section__description">' + dataset.description + '</p>' +
        '<label for="learn-more' + i + '" class="teaser-section__more-label js-more-details" onmouseup="clickDetails(\'' + dataset.infoUrl.toString() + '\', \'js-more-details-target' + dataset.id + '\');"><input type="checkbox" class="teaser-section__more-button" name="learn-more' + i + '" id="learn-more' + i + '" /> Mehr dar√ºber</label>' +
        '<dl class="teaser-section__more">' +
        // more details here:
        '<dt>Weitere Infos:</dt>' +
        '<dd class="js-more-details-target' + dataset.id + '"></dd>' +
        '</dl>' +
        '</div>' +
        '</article>'
      );
    }

    // insert detail template
    function insertDetailTemplate(detailTarget, detailDataset) {
      console.log('trmplate!');
       detailTarget.insertAdjacentHTML('afterbegin',
        '<dl>' +
        '<dt>Wo wird veranstaltet?</dt>' +
        '<dd>' + detailDataset.LocationName + ', ' + detailDataset.LocationStreetAddress + ', ' + detailDataset.LocationZIP + ' ' + detailDataset.locationCity + '</dd>' +
        '<dt>Wer veranstaltet?</dt>' +
        '<dd>' + detailDataset.VeranstalterName + ', ' + detailDataset.VeranstalterEMail + ', ' + detailDataset.VeranstalterWebSite + '</dd>' +
        '</dl>'
      );
    }

    // TODO: fetch and generate Details
    function generateDetails(detailTarget) {
      console.log(httpRequest.readyState, httpRequest.status);

      if (httpRequest.readyState === httpRequest.DONE) {
        if (httpRequest.status === 200) {
          var detailData = JSON.parse(httpRequest.responseText);
          var detailTargetSpec = document.getElementsByClassName(detailTarget);

          var detailDataset = {
            //locationCity: detailData.LocationCity || 'no data',
            locationCity: detailData[0].DocName || 'no data',
            LocationName: detailData.LocationName || 'no data',
            LocationStreetAddress: detailData.LocationStreetAddress || 'no data',
            LocationZIP: detailData.LocationZIP || 'no data',
            VeranstalterName: detailData.VeranstalterName || 'no data',
            VeranstalterEMail: detailData.VeranstalterEMail || 'no data',
            VeranstalterWebSite: detailData.VeranstalterWebSite || 'no data'
          };

          insertDetailTemplate(detailTargetSpec[0], detailDataset);

        } else {
          targetMessage.classList.remove('hide');
          document.getElementById('jsStatus').textContent = 'Ich brauche JavaScript!';
          return false;
        }
      }
    }

    // generate main content
    function generateContents() {
      console.log(httpRequest.readyState, httpRequest.status);
      
      if (httpRequest.readyState === httpRequest.DONE) {
        if (httpRequest.status === 200) {
          var data = JSON.parse(httpRequest.responseText);
          var dataset;
          var articleTarget = document.getElementById('jsTeaserSpirituous');

          document.getElementById('jsTeaserSpirituous').innerHTML = '';
          document.getElementById('jsTeaserNonAlc').innerHTML = '';

          for (var i = 0; i < data.length; i++) {
            dataset = {
              id: data[i]['@unid'],
              startdate: data[i].Start || 'no data',
              enddate: data[i].End || 'no data',
              title: data[i].DocName || '-',
              subtitle: data[i].EventSubTitle || '-',
              description: data[i].Kurztext || '-',
              infoUrl: 'https://crossorigin.me/https://www.krefeld.de/' + data[i].URL || '#',
              thumb: data[i].Thumb,
              startDate: data[i].Start || 'unbekannt',
              endDate: data[i].End || 'unbekannt',
              tags: data[i].EventType || 'Keine Tags'
            };
            insertTemplate(articleTarget, dataset, i);
          }
          targetMessage.classList.add('hide');

        } else {
          targetMessage.classList.remove('hide');
          document.getElementById('jsStatus').textContent = 'Ich habe leider keine Verbindung!';
          return false;
        }
      }
    }

    // click for details
    function clickDetails(detailUrl, detailTarget) {
      httpRequest = new XMLHttpRequest();
      makeRequest('' + detailUrl + '', generateDetails(detailTarget));
    };

    // live search
    function liveSearch() {
      var search = document.getElementById('search');
      search.onkeyup = function () {
        var filter = search.value.toUpperCase();
        var lis = document.getElementsByTagName('article');
        for (var i = 0; i < lis.length; i++) {
          var target = lis[i].getElementsByClassName('search-content')[0];
          var content = target.textContent;
          if (content.toUpperCase().indexOf(filter) > -1) {
            lis[i].style.display = 'block';
          } else {
            lis[i].style.display = 'none';
          }
        }
      }
    };

    function getTags(dataset) {
      var allTags = dataset.tags.toString();
      return allTags;
    };

    function setImage(dataset) {
      if (dataset.thumb === '') {
        return (
          '<svg class="teaser-section__image teaser-section__icon-smiley" height="150" width="150"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-smiley"></use></svg>'
        )
      } else {
        return (
          '<img class="teaser-section__image" width="150" height="150" src="' + dataset.thumb + '" alt="" />'
        )
      }
    }

    function formatDate(dataset) {
      var newDate;
      var startDateRaw = dataset.startDate;
      var endDateRaw = dataset.endDate;
      var startDate;
      var endDate;

      if (startDateRaw !== 'unbekannt') {
        var tempDateStart = startDateRaw.split('-');
        var tempDateDayStart = tempDateStart[2].split('T');
        startDate = tempDateDayStart[0] + '.' + tempDateStart[1] + '.' + tempDateStart[0];
      } else {
        startDate = '(keine Angabe)';
      }

      if (endDateRaw !== 'unbekannt') {
        var tempDateEnd = endDateRaw.split('-');
        var tempDateDayEnd = tempDateEnd[2].split('T');
        endDate = tempDateDayEnd[0] + '.' + tempDateEnd[1] + '.' + tempDateEnd[0];
        newDate = '<p>Vom <strong>' + startDate + '</strong> bis <strong>' + endDate + '</strong></p>';
      } else {
        newDate = '<p>Am <strong>' + startDate + '</strong></p>';
      }
      return newDate;
    }

    // accessibility
    var section1 = document.getElementById('jsSection1');
    var section2 = document.getElementById('jsSection2');
    var section1Inputs = section1.getElementsByTagName('input');
    var section2Inputs = section2.getElementsByTagName('input');
    var catMenu1 = document.getElementById('category01');
    var catMenu2 = document.getElementById('category02');
    var filter1Cat1 = document.getElementById('category01-filter01');
    var filter2Cat1 = document.getElementById('category01-filter02');
    var filter1Cat2 = document.getElementById('category02-filter01');
    var filter2Cat2 = document.getElementById('category02-filter02');
    var filterTag1Cat1 = section1.querySelectorAll('[data-tag="beginner"]');
    var filterTag2Cat1 = section1.querySelectorAll('[data-tag="advanced"]');
    var filterTag1Cat2 = section2.querySelectorAll('[data-tag="beginner"]');
    var filterTag2Cat2 = section2.querySelectorAll('[data-tag="advanced"]');

    // initially set section2Inputs inactive
    var setInitialNotActive = function () {
      for (var i = 0; i < section2Inputs.length; i++) {
        section2Inputs[i].setAttribute('tabindex', '-1');
      }
      section2.setAttribute('aria-hidden', 'true');
    };
    window.onload = setInitialNotActive;

    // aria controls
    /*
    catMenu1.onfocus = function() {
      section1.setAttribute('aria-hidden', 'false');
      section2.setAttribute('aria-hidden', 'true');
      for(var i=0; i<section1Inputs.length; i++) {
          section1Inputs[i].setAttribute('tabindex', '0');
      }
      for(var x=0; x<section2Inputs.length; x++) {
          section2Inputs[x].setAttribute('tabindex', '-1');
      }
    };
    catMenu2.onfocus = function() {
      section1.setAttribute('aria-hidden', 'true');
      section2.setAttribute('aria-hidden', 'false');
      for(var i=0; i<section1Inputs.length; i++) {
          section1Inputs[i].setAttribute('tabindex', '-1');
      }
      for(var x=0; x<section2Inputs.length; x++) {
          section2Inputs[x].setAttribute('tabindex', '0');
      }
    };

    filter1Cat1.onchange = function() {
      if (this.checked) {
        for(var i=0; i<filterTag2Cat1.length; i++) {
          filterTag2Cat1[i].setAttribute('aria-hidden', 'true');
        }
        for(var x=0; x<filterTag1Cat1.length; x++) {
          filterTag1Cat1[x].setAttribute('aria-hidden', 'false');
        }
      }
    };
    filter2Cat1.onchange = function() {
      if (this.checked) {
        for(var i=0; i<filterTag2Cat1.length; i++) {
          filterTag2Cat1[i].setAttribute('aria-hidden', 'false');
        }
        for(var x=0; x<filterTag1Cat1.length; x++) {
          filterTag1Cat1[x].setAttribute('aria-hidden', 'true');
        }
      }
    };
    filter1Cat2.onchange = function() {
      if (this.checked) {
        for(var i=0; i<filterTag2Cat2.length; i++) {
          filterTag2Cat2[i].setAttribute('aria-hidden', 'true');
        }
        for(var x=0; x<filterTag1Cat2.length; x++) {
          filterTag1Cat2[x].setAttribute('aria-hidden', 'false');
        }
      }
    };
    filter2Cat2.onchange = function() {
      if (this.checked) {
        if (this.checked) {
          for(var i=0; i<filterTag2Cat2.length; i++) {
            filterTag2Cat2[i].setAttribute('aria-hidden', 'false');
          }
          for(var x=0; x<filterTag1Cat2.length; x++) {
            filterTag1Cat2[x].setAttribute('aria-hidden', 'true');
          }
        }
      }
    };
    */

    // Init
    makeRequest('https://crossorigin.me/https://www.krefeld.de/www_familie/event.nsf/apijson.xsp/view-event-month?compact=true', generateContents);
    liveSearch();

  </script>


</body>

</html>